generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Пользователи системы
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String   @default("MANAGER") // ADMIN, MANAGER
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings  Booking[] @relation("CreatedBy")
  assigned  Booking[] @relation("AssignedTo")
}

// Типы туров (ER, CO, KAS, ZA и т.д.)
model TourType {
  id          Int       @id @default(autoincrement())
  code        String    @unique // ER, CO, KAS, ZA
  name        String    // Полное название
  description String?
  color       String    @default("#3B82F6") // Цвет для UI
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  bookings    Booking[]
  itinerary   TourItinerary[]
}

// Программа тура (день за днем)
model TourItinerary {
  id          Int       @id @default(autoincrement())
  tourTypeId  Int
  tourType    TourType  @relation(fields: [tourTypeId], references: [id], onDelete: Cascade)

  dayNumber   Int                      // Номер дня (1, 2, 3...)
  title       String                   // Заголовок дня (например: "День 1: Прибытие в Ташкент")
  description String?                  // Описание программы дня
  activities  String?                  // Активности дня (может быть JSON или текст)
  meals       String?                  // Питание (Завтрак, Обед, Ужин)
  accommodation String?                // Размещение (название отеля)

  sortOrder   Int       @default(0)    // Порядок сортировки
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tourTypeId])
  @@index([dayNumber])
}

// Гиды / Рейселейтеры
model Guide {
  id          Int       @id @default(autoincrement())

  // Основная информация (видна всем)
  name        String    @unique  // Отображаемое имя (для совместимости)
  firstName   String?            // Имя
  lastName    String?            // Фамилия
  dateOfBirth DateTime?          // Дата рождения
  phone       String?
  email       String?

  // Паспортные данные (только для админа, зашифровано)
  passportNumber     String?     // Номер паспорта
  passportIssueDate  DateTime?   // Дата выдачи
  passportExpiryDate DateTime?   // Срок действия
  passportIssuedBy   String?     // Кем выдан

  // Банковские данные (только для админа, зашифровано)
  bankAccountNumber  String?     // Номер счёта
  bankCardNumber     String?     // Номер карты
  bankName           String?     // Название банка

  // Адрес
  address     String?

  // Примечания
  notes       String?

  // Payment rates (in USD)
  dayRate     Float?    @default(110)   // Full day rate in USD
  halfDayRate Float?    @default(55)    // Half day rate in USD

  // City-specific rates
  city        String?                   // City name for city-specific rate
  cityRate    Float?    @default(0)     // City-specific rate in USD

  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt @default(now())

  bookings    Booking[]
  guidePayments GuidePayment[]
}

// Выплаты гидам (для будущего модуля бухгалтерии)
model GuidePayment {
  id          Int       @id @default(autoincrement())
  guideId     Int
  guide       Guide     @relation(fields: [guideId], references: [id])
  bookingId   Int?
  amount      Float
  currency    String    @default("UZS")
  paymentDate DateTime
  paymentType String    @default("SALARY") // SALARY, BONUS, ADVANCE
  notes       String?
  createdAt   DateTime  @default(now())
}

// Основная таблица бронирований
model Booking {
  id              Int       @id @default(autoincrement())
  bookingNumber   String    @unique // ER-01, CO-05, KAS-12
  tourTypeId      Int
  tourType        TourType  @relation(fields: [tourTypeId], references: [id])

  // Даты
  departureDate   DateTime  // Depature / Ankunft
  arrivalDate     DateTime  // Ankunft (прибытие)
  endDate         DateTime  // Abflug (вылет/окончание)

  // Туристы
  pax             Int       @default(0) // Общее количество
  paxUzbekistan   Int?      // Туристы в Узбекистане
  paxTurkmenistan Int?      // Туристы в Туркменистане
  country         String?   // Страна группы (Germany, France, etc.)

  // Гид
  guideId         Int?
  guide           Guide?    @relation(fields: [guideId], references: [id])
  guideFullDays   Float?    @default(0)  // Количество полных дней работы гида
  guideHalfDays   Float?    @default(0)  // Количество половинных дней работы гида
  mainGuideData   String?                // JSON объект для основного гида (manual or selected)

  // Дополнительные гиды (JSON)
  additionalGuides String?               // JSON массив дополнительных гидов
  bergreiseleiter  String?               // JSON объект для Bergreiseleiter

  // Транспорт
  trainTickets    String?   // ЖД Билеты
  avia            String?   // Авиабилеты

  // Номера в отелях (legacy - простые подсчёты)
  roomsDbl        Float     @default(0) // Double rooms
  roomsTwn        Float     @default(0) // Twin rooms
  roomsSngl       Float     @default(0) // Single rooms
  roomsTotal      Float     @default(0) // Всего номеров

  // Размещение в отелях (детальное) - legacy
  bookingRooms    BookingRoom[]

  // Размещение (новая структура)
  accommodations  Accommodation[]

  // Туристы (индивидуальные гости)
  tourists        Tourist[]

  // Rooming List записи
  roomingListEntries RoomingListEntry[]

  // Рейсы
  flights         Flight[]

  // Raw flight sections from PDF
  flightSections  FlightSection[]

  // Поезда
  railways        Railway[]

  // Raw railway sections from PDF
  railwaySections RailwaySection[]

  // Маршруты транспорта
  routes          Route[]

  // Tour services (Eintritt, Metro, Shou, Other)
  tourServices    TourService[]

  // Invoices (Rechnung, Neue Rechnung, Gutschrift)
  invoices        Invoice[]

  // Дополнительные даты для ZA туров
  dateOlot        DateTime? // Olot
  dateJartepa     DateTime? // Jartepa
  dateOybek       DateTime? // Oybek
  dateChernyaevka DateTime? // Chernyaevka

  // Статус и примечания
  status          String    @default("PENDING") // PENDING, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED
  notes           String?

  // Rechnung firma (Orient Insight / INFUTURESTORM)
  rechnungFirma   String?   // Orient Insight, INFUTURESTORM

  // Метаданные
  createdById     Int?
  createdBy       User?     @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToId    Int?
  assignedTo      User?     @relation("AssignedTo", fields: [assignedToId], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([departureDate])
  @@index([status])
  @@index([tourTypeId])
}

// Будущий модуль: Заявки
model Request {
  id            Int      @id @default(autoincrement())
  requestNumber String   @unique
  clientName    String
  clientPhone   String?
  clientEmail   String?
  tourTypeId    Int?
  preferredDate DateTime?
  pax           Int      @default(1)
  status        String   @default("NEW") // NEW, PROCESSING, CONVERTED, DECLINED
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Invoices (Rechnung, Neue Rechnung, Gutschrift)
model Invoice {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  invoiceNumber   String    // Sequential: "1", "2", "3"...
  invoiceType     String    // "Rechnung", "Neue Rechnung", "Gutschrift"
  firma           String?   // "Orient Insight", "INFUTURESTORM"

  // Invoice items (JSON array from RechnungDocument)
  items           String?   // JSON array of invoice line items

  totalAmount     Float     @default(0)
  currency        String    @default("USD")

  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([invoiceType])
  @@index([firma])
}


// ============================================
// Модуль: Отели
// ============================================

// Города
model City {
  id        Int      @id @default(autoincrement())
  name      String   @unique  // Ташкент, Самарканд, Бухара
  nameEn    String?           // English name
  country   String   @default("Uzbekistan")
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  hotels         Hotel[]
}

// Отели
model Hotel {
  id          Int       @id @default(autoincrement())
  name        String                   // Название отеля
  cityId      Int
  city        City      @relation(fields: [cityId], references: [id])
  address     String?                  // Адрес
  phone       String?                  // Телефон
  email       String?                  // Email
  website     String?                  // Вебсайт
  stars       String?                  // Звёздность (1-5, Guesthouse, Yurta)
  description String?                  // Описание
  totalRooms  Int       @default(0)    // Общее количество номеров в отеле (для расчёта турсбора)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  roomTypes      RoomType[]
  bookingRooms   BookingRoom[]
  accommodations Accommodation[]
  images         HotelImage[]

  @@unique([name, cityId])
  @@index([cityId])
}

// Изображения отелей
model HotelImage {
  id          Int      @id @default(autoincrement())
  hotelId     Int
  hotel       Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  filename    String                   // Имя файла на диске
  originalName String                  // Оригинальное имя файла
  url         String                   // URL для доступа
  caption     String?                  // Подпись к фото
  sortOrder   Int      @default(0)     // Порядок сортировки
  isMain      Boolean  @default(false) // Главное фото
  createdAt   DateTime @default(now())

  @@index([hotelId])
}

// Типы номеров
model RoomType {
  id            Int      @id @default(autoincrement())
  hotelId       Int
  hotel         Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  name          String                  // DBL, TWN, SNGL, Suite
  displayName   String?                 // Полное название: "Double Room", "Twin Room"
  roomCount     Int      @default(0)    // Количество номеров
  pricePerNight Float    @default(0)    // Базовая цена за ночь (default)
  currency      String   @default("USD")
  description   String?                 // Описание номера
  amenities     String?                 // Удобства (JSON или текст)
  maxGuests     Int      @default(2)    // Макс. гостей

  // НДС (12%)
  vatIncluded   Boolean  @default(false) // Включен ли НДС 12% в цену

  // Туристический сбор (только для отелей в Узбекистане)
  touristTaxEnabled Boolean @default(false)  // Включен ли турсбор для этого типа номера
  brvValue          Float?  @default(0)      // БРВ - Базовая расчётная величина (в сумах UZS)

  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bookingRooms       BookingRoom[]
  accommodationRooms AccommodationRoom[]
  accommodations     Accommodation[]
  seasonalPrices     RoomSeasonalPrice[]

  @@index([hotelId])
  @@index([hotelId, name])
}

// Сезонные цены на номера
model RoomSeasonalPrice {
  id            Int      @id @default(autoincrement())
  roomTypeId    Int
  roomType      RoomType @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  name          String                  // "Лето", "Зима", "Высокий сезон"
  startDate     DateTime                // Начало сезона (месяц-день)
  endDate       DateTime                // Конец сезона (месяц-день)
  pricePerNight Float                   // Цена за этот сезон
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([roomTypeId])
}

// Размещение в отелях для бронирований
model BookingRoom {
  id            Int       @id @default(autoincrement())
  bookingId     Int
  booking       Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hotelId       Int
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  roomTypeId    Int
  roomType      RoomType  @relation(fields: [roomTypeId], references: [id])
  checkInDate   DateTime                 // Дата заезда
  checkOutDate  DateTime                 // Дата выезда
  quantity      Int       @default(1)    // Количество номеров
  pricePerNight Float     @default(0)    // Цена за ночь
  totalPrice    Float     @default(0)    // Итоговая цена
  notes         String?                  // Примечания
  createdAt     DateTime  @default(now())

  // Назначения туристов в этот номер
  touristAssignments TouristRoomAssignment[]

  @@index([bookingId])
  @@index([hotelId])
  @@index([roomTypeId])
  @@index([checkInDate])
  @@index([checkOutDate])
}

// ============================================
// Модуль: Размещение (Accommodation)
// ============================================

// Глобальный справочник типов размещения (DBL, TWN, SNGL, TRPL, EXTRA)
model AccommodationRoomType {
  id            Int       @id @default(autoincrement())
  code          String    @unique        // DBL, TWN, SNGL, TRPL, EXTRA
  name          String                   // Double, Twin, Single, Triple, Extra Bed
  description   String?                  // Описание
  maxGuests     Int       @default(2)    // Макс. гостей
  sortOrder     Int       @default(0)    // Порядок сортировки
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())

  accommodations Accommodation[]
  accommodationRooms AccommodationRoom[]
}

// Размещение в отеле (один отель + один тип номера)
model Accommodation {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hotelId         Int
  hotel           Hotel     @relation(fields: [hotelId], references: [id])
  roomTypeCode    String?                 // Код типа размещения (DBL, TWN, SNGL, etc.)
  accommodationRoomType AccommodationRoomType? @relation(fields: [roomTypeCode], references: [code])
  checkInDate     DateTime
  checkOutDate    DateTime
  nights          Int       @default(0)  // Рассчитывается на бэкенде
  totalCost       Float     @default(0)  // Общая стоимость (из frontend)
  totalRooms      Int       @default(0)  // Общее кол-во номеров
  totalGuests     Int       @default(0)  // Общее кол-во гостей
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Legacy: для обратной совместимости
  roomTypeId    Int?
  roomType      RoomType? @relation(fields: [roomTypeId], references: [id])
  rooms         AccommodationRoom[]
  roomingList   AccommodationRoomingList[]

  @@index([bookingId])
  @@index([hotelId])
  @@index([roomTypeCode])
  @@index([checkInDate])
}

// Отдельный тип номера в размещении
model AccommodationRoom {
  id              Int           @id @default(autoincrement())
  accommodationId Int
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)
  roomTypeCode    String        @default("DBL") // Код типа размещения (DBL, TWN, SNGL, etc.)
  accommodationRoomType AccommodationRoomType? @relation(fields: [roomTypeCode], references: [code])
  roomsCount      Int           @default(1)    // Количество номеров этого типа
  guestsPerRoom   Int           @default(2)    // Гостей в номере
  pricePerNight   Float         @default(0)    // Цена за ночь
  totalCost       Float         @default(0)    // Общая стоимость (рассчитывается на бэкенде)
  createdAt       DateTime      @default(now())

  // Legacy поля для обратной совместимости
  roomTypeId      Int?
  roomType        RoomType?     @relation(fields: [roomTypeId], references: [id])

  @@index([accommodationId])
  @@index([roomTypeCode])
}

// ============================================
// Модуль: Туристы (Tourists)
// ============================================

// Туристы (индивидуальные гости)
model Tourist {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Персональные данные
  firstName           String                   // Имя
  lastName            String                   // Фамилия
  fullName            String?                  // Полное имя (для отображения)
  gender              String?                  // M/F
  passportNumber      String?                  // Номер паспорта (опционально)
  dateOfBirth         DateTime?               // Дата рождения
  passportExpiryDate  DateTime?               // Срок действия паспорта
  country             String?   @default("Not provided") // Страна (Germany, Austria, etc.)

  // Размещение (страна тура)
  accommodation   String?   @default("Not assigned") // Uzbekistan, Turkmenistan, Not assigned

  // Размещение в отеле
  hotelName       String?                  // Название отеля (для заявок)
  checkInDate     DateTime?                // Дата заезда (индивидуальная)
  checkOutDate    DateTime?                // Дата выезда (индивидуальная)

  // Предпочтения по размещению
  roomPreference  String?                  // DBL, TWN, SNGL
  roomNumber      String?                  // Room grouping identifier (e.g., DBL-1, TWN-2, SNGL-3)
  roommateId      Int?                     // ID сожителя (для пар)

  // Статус
  isGroupLeader   Boolean   @default(false) // Лидер группы
  notes           String?
  remarks         String?              // Примечания

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Назначения в номера
  roomAssignments TouristRoomAssignment[]
  accommodationRoomingList AccommodationRoomingList[]

  @@index([bookingId])
  @@index([lastName])
}

// Назначение туриста в номер
model TouristRoomAssignment {
  id              Int       @id @default(autoincrement())
  touristId       Int
  tourist         Tourist   @relation(fields: [touristId], references: [id], onDelete: Cascade)
  bookingRoomId   Int
  bookingRoom     BookingRoom @relation(fields: [bookingRoomId], references: [id], onDelete: Cascade)

  // Индивидуальные даты (для продлённого проживания)
  checkInDate     DateTime?                // NULL = использовать даты из BookingRoom
  checkOutDate    DateTime?                // NULL = использовать даты из BookingRoom

  // Для дополнительных ночей
  extraNights     Int       @default(0)    // Дополнительные ночи
  extraCost       Float     @default(0)    // Доп. стоимость

  notes           String?
  createdAt       DateTime  @default(now())

  @@unique([touristId, bookingRoomId])  // Один турист - одно назначение на номер
  @@index([touristId])
  @@index([bookingRoomId])
}

// Rooming List для конкретного размещения (hotel-specific tourist dates)
model AccommodationRoomingList {
  id              Int       @id @default(autoincrement())
  accommodationId Int
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)
  touristId       Int
  tourist         Tourist   @relation(fields: [touristId], references: [id], onDelete: Cascade)

  // Hotel-specific dates (override Tourist.checkInDate/checkOutDate for this hotel)
  checkInDate     DateTime?                // Дата заезда в этот отель
  checkOutDate    DateTime?                // Дата выезда из этого отеля
  roomPreference  String?                  // Room type для этого отеля (DBL, TWN, SNGL)

  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([accommodationId, touristId])  // One tourist per accommodation
  @@index([accommodationId])
  @@index([touristId])
}

// ============================================
// Модуль: Рейсы (Flights)
// ============================================

// Информация о рейсах для бронирования
model Flight {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Тип рейса
  type            String    @default("INTERNATIONAL") // INTERNATIONAL, DOMESTIC

  // Информация о рейсе
  flightNumber    String?                  // Номер рейса (например, HY101)
  airline         String?                  // Авиакомпания
  groupName       String?                  // Группа (например, ER-01)
  route           String?                  // Маршрут
  departure       String                   // Город вылета (используется для цены)
  arrival         String                   // Город прибытия (используется для цены)

  // Дата и время
  date            DateTime?                // Дата рейса
  departureTime   String?                  // Время вылета (HH:MM)
  arrivalTime     String?                  // Время прибытия (HH:MM)

  // Количество пассажиров
  pax             Int?                     // Количество пассажиров

  // Стоимость
  price           Float     @default(0)    // Цена билетов (USD)
  tariff          String?   @default("economy") // Тариф: economy или business

  // Дополнительная информация
  notes           String?
  sortOrder       Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([type])
}

// ============================================
// Модуль: Flight Sections (Raw content from PDF)
// ============================================

// Raw flight section content extracted from PDF
model FlightSection {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Type: INTERNATIONAL or DOMESTIC
  type            String    @default("INTERNATIONAL")

  // Raw text content extracted from PDF
  rawContent      String?                  // Raw text block from PDF

  // Image content (base64 encoded) for image-based flight info
  imageData       String?                  // Base64 encoded image data
  imageMimeType   String?                  // image/png, image/jpeg, etc.

  // Metadata
  sourceFileName  String?                  // Original PDF filename
  pageNumber      Int?                     // Page number in PDF where found

  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([type])
}

// ============================================
// Модуль: Railways (Поезда)
// ============================================

// Информация о поездах для бронирования
model Railway {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Тип поезда
  type            String    @default("INTERNATIONAL") // INTERNATIONAL, DOMESTIC

  // Информация о поезде
  trainNumber     String?                  // Номер поезда (например, 661)
  trainName       String?                  // Название поезда
  groupName       String?                  // Группа (например, ER-01)
  departure       String                   // Город отправления
  arrival         String                   // Город прибытия

  // Дата и время
  date            DateTime?                // Дата отправления
  departureTime   String?                  // Время отправления (HH:MM)
  arrivalTime     String?                  // Время прибытия (HH:MM)

  // Количество пассажиров
  pax             Int?                     // Количество пассажиров

  // Стоимость
  price           Float     @default(0)    // Цена билетов (USD)

  // Дополнительная информация
  notes           String?
  sortOrder       Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([type])
}

// ============================================
// Модуль: Railway Sections (Raw content from PDF)
// ============================================

// Raw railway section content extracted from PDF
model RailwaySection {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Type: INTERNATIONAL or DOMESTIC
  type            String    @default("INTERNATIONAL")

  // Raw text content extracted from PDF
  rawContent      String?                  // Raw text block from PDF

  // Image content (base64 encoded) for image-based railway info
  imageData       String?                  // Base64 encoded image data
  imageMimeType   String?                  // image/png, image/jpeg, etc.

  // Metadata
  sourceFileName  String?                  // Original PDF filename
  pageNumber      Int?                     // Page number in PDF where found

  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([type])
}

// ============================================
// Модуль: Route (Маршруты транспорта)
// ============================================

// Маршруты для бронирования
model Route {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Основные данные
  dayNumber       Int       @default(1)    // Номер дня
  dayOffset       Int       @default(1)    // Смещение дней от даты вылета (для расчета даты маршрута)
  date            DateTime?                // Дата маршрута
  city            String?                  // Город (Tashkent, Samarkand, etc.)
  routeName       String                   // Название маршрута (Tashkent Airport PickUp, etc.)
  itinerary       String?                  // Sayohat dasturi (описание маршрута)

  // Транспорт
  personCount     Int       @default(0)    // Количество человек
  transportType   String?                  // Тип транспорта (Joylong, Starex, etc.)

  // Поставщик
  provider        String?                  // Провайдер (xayrulla, sevil, etc.)
  optionRate      String?                  // Опция тарифа
  price           Float     @default(0)    // Цена

  sortOrder       Int       @default(0)    // Порядок сортировки
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([date])
}

// Route templates for tour types (default routes for ER, CO, etc.)
model RouteTemplate {
  id              Int       @id @default(autoincrement())
  tourTypeCode    String                   // ER, CO, KAS, ZA

  // Основные данные
  dayNumber       Int       @default(1)    // Номер дня
  dayOffset       Int       @default(1)    // Смещение дней от даты вылета
  city            String?                  // Город (Tashkent, Samarkand, etc.)
  routeName       String                   // Название маршрута
  itinerary       String?                  // Sayohat dasturi (описание маршрута)

  // Транспорт (default values)
  provider        String?                  // Провайдер (xayrulla, sevil, etc.)
  optionRate      String?                  // Опция тарифа

  sortOrder       Int       @default(0)    // Порядок сортировки
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tourTypeCode])
}

// Accommodation templates for tour types (default hotels for ER, CO, etc.)
model AccommodationTemplate {
  id              Int       @id @default(autoincrement())
  tourTypeCode    String                   // ER, CO, KAS, ZA

  // Hotel info
  hotelId         Int?                     // Hotel ID from Hotel table
  hotelName       String?                  // Hotel name (for display)
  cityId          Int?                     // City ID
  cityName        String?                  // City name (for display)

  // Dates (offsets from departure date)
  checkInOffset   Int       @default(0)    // Days offset from departure for check-in
  checkOutOffset  Int       @default(1)    // Days offset from departure for check-out
  nights          Int       @default(1)    // Number of nights

  sortOrder       Int       @default(0)    // Order in list
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tourTypeCode])
}

// ============================================
// Модуль: Transport (Транспорт - Opex)
// ============================================

// Transport providers (Sevil, Xayrulla, Nosir, Train, Plane, Metro)
model TransportVehicle {
  id              Int       @id @default(autoincrement())

  // Provider category
  provider        String                   // sevil, xayrulla, nosir, train, plane, metro

  // Basic info
  name            String                   // Vehicle name (Starex, Joylong, Yutong 33, etc.)
  seats           String?                  // Number of seats
  person          String?                  // Person range (1-4, 5-8, 9-20, etc.)

  // Sevil rates
  pickupDropoff   String?                  // Pickup/Dropoff rate
  tagRate         Float?                   // Tag rate
  urgenchRate     Float?                   // Urgench rate
  shovotRate2     Float?                   // Shovot rate 2
  olotRate        Float?                   // Olot rate (for ZA tours)
  jartepaRate     Float?                   // Jartepa rate (for ZA tours)

  // Xayrulla rates
  vstrecha        Float?                   // Vstrecha rate
  chimgan         Float?                   // Chimgan rate
  tag             Float?                   // Tag rate (Xayrulla)
  oybek           Float?                   // Oybek rate
  chernyayevka    Float?                   // Chernyayevka rate
  cityTour        Float?                   // City Tour rate

  // Nosir rates
  margilan        Float?                   // Margilan rate
  qoqon           Float?                   // Qoqon rate
  dostlik         Float?                   // Dostlik rate
  toshkent        Float?                   // Toshkent rate
  extra           Float?                   // Extra rate

  // Train/Plane fields
  trainNumber     String?                  // Train number (e.g., 764Ф)
  route           String?                  // Route name
  economPrice     String?                  // Economy price
  businessPrice   String?                  // Business price
  departure       String?                  // Departure time
  arrival         String?                  // Arrival time
  flightType      String?                  // Flight type: DOMESTIC or INTERNATIONAL (for planes only)

  sortOrder       Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([provider])
}

// ============================================
// Модуль: Rooming List (Лист размещения)
// ============================================

// Запись Rooming List (независимая от туристов)
model RoomingListEntry {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Персональные данные
  firstName       String                   // Имя
  lastName        String                   // Фамилия
  gender          String?                  // M/F (опционально)
  country         String?                  // Страна (Germany, Austria, etc.)
  dateOfBirth     DateTime?               // Дата рождения

  // Размещение
  roomType        String    @default("DBL") // DBL, TWN, SNGL, TRPL, Suite
  placement       String    @default("Uzbekistan") // Uzbekistan, Turkmenistan, etc.
  roomPairId      Int?                     // ID пары для объединения в комнату (DBL/TWN)

  // Дополнительная информация
  isVegetarian    Boolean   @default(false) // Вегетарианец
  remarks         String?

  // Порядок сортировки (для сохранения оригинального порядка из PDF)
  sortOrder       Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([roomType])
  @@index([placement])
  @@index([roomPairId])
}

// ============================================
// Модуль: Gmail Integration (Email Imports)
// ============================================

// Email import tracking
model EmailImport {
  id              Int       @id @default(autoincrement())

  // Gmail metadata
  gmailMessageId  String    @unique
  emailSubject    String?
  emailFrom       String
  emailDate       DateTime

  // Attachment
  attachmentName  String?
  attachmentUrl   String?
  attachmentType  String?

  // Processing
  status          String    @default("PENDING") // PENDING, PROCESSING, SUCCESS, FAILED, MANUAL_REVIEW
  rawParsedData   String?   // JSON from Claude
  errorMessage    String?

  // Results
  bookingsCreated Int       @default(0)
  bookingsUpdated Int       @default(0)
  bookingIds      String?   // "123,124,125"

  // Metadata
  processedAt     DateTime?
  processedBy     String?   @default("SYSTEM")
  retryCount      Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status])
  @@index([emailFrom])
  @@index([emailDate])
}

// System settings (key-value store)
model SystemSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String   // Stored as TEXT in SQLite
  encrypted Boolean  @default(false)
  updatedAt DateTime @updatedAt
}

// ============================================
// Module: Tour Services (Eintritt, Metro, Shou, Other)
// ============================================

// Generic tour service entry (entrance fees, metro, shows, other expenses)
model TourService {
  id              Int       @id @default(autoincrement())
  bookingId       Int
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Service type
  type            String                   // EINTRITT, METRO, SHOU, OTHER

  // Basic data
  name            String                   // Service name (Museum name, Show name, etc.)
  city            String?                  // City name (Tashkent, Samarkand, etc.)
  date            DateTime?                // Service date
  pricePerPerson  Float     @default(0)    // Price per person
  pax             Int       @default(0)    // Number of passengers
  price           Float     @default(0)    // Total price (pricePerPerson * pax)
  notes           String?                  // Additional notes

  sortOrder       Int       @default(0)    // Sort order
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookingId])
  @@index([type])
}

// ============================================
// Module: Price Configuration (Цены для Price page)
// ============================================

// Price configurations for different tour types and categories
model PriceConfig {
  id              Int       @id @default(autoincrement())

  // Tour type (ER, CO, KAS, ZA, PREIS2026)
  tourType        String                   // ER, CO, KAS, ZA, PREIS2026

  // Category (hotels, transport, railway, fly, meal, sightseeing, guide, shou, zusatzkosten)
  category        String                   // hotels, transport, railway, fly, meal, sightseeing, guide, shou, zusatzkosten

  // PAX tier (for transport routes that vary by group size)
  paxTier         String                   // "4", "5", "6-7", "8-9", "10-11", "12-13", "14-15", "16"

  // Price items as JSON
  itemsJson       String                   // JSON array of price items

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([tourType, category, paxTier])
  @@index([tourType])
  @@index([category])
}

// ============================================
// Module: Audit Log (Логирование действий)
// ============================================

// Audit log for tracking user actions
model AuditLog {
  id           Int      @id @default(autoincrement())
  userId       Int?
  action       String
  resource     String?
  resourceId   Int?
  ipAddress    String?
  userAgent    String?
  status       String
  errorMessage String?
  metadata     String?
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([userId])
}
